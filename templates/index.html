<!DOCTYPE html>
<html lang="tr" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOL</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .container { max-width: 1800px; }
        h1 { font-size: 2rem; margin-bottom: 20px; }
        .status-bar { font-size: 0.9rem; color: #198754; margin-bottom: 10px; font-weight: bold;}
        th { cursor: pointer; user-select: none; vertical-align: middle; }
        th:hover { background-color: #343a40; }
        .sort-icon::after { content: ' ↕'; font-size: 0.8em; opacity: 0.5; }
        .sort-asc::after { content: ' ↑'; opacity: 1; }
        .sort-desc::after { content: ' ↓'; opacity: 1; }
        
        /* Input stili */
        .spread-input-group { width: 140px; }
        .spread-input-group input { text-align: center; font-weight: bold; }
        /* Tablo hücre hizalamaları */
        td { vertical-align: middle; }
    </style>
</head>
<body>
    <div class="container p-4 shadow-sm rounded border">
        <h1>⚡ Excel'den Canlı Veri Akışı (Kaydetme Gerektirmez)</h1>
        <div id="status" class="status-bar">Bağlanıyor...</div>
        
        <!-- Filters -->
        <div class="row mb-3 g-2">
            <div class="col-md-2">
                <label for="filter-dayanak" class="form-label text-muted small mb-0">Dayanak Varlık</label>
                <select id="filter-dayanak" class="form-select form-select-sm" onchange="applyFilters()">
                    <option value="">Tümü</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="filter-tip" class="form-label text-muted small mb-0">Tip</label>
                <select id="filter-tip" class="form-select form-select-sm" onchange="applyFilters()">
                    <option value="">Tümü</option>
                    <option value="Call">Call</option>
                    <option value="Put">Put</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="filter-vade" class="form-label text-muted small mb-0">Vade</label>
                <select id="filter-vade" class="form-select form-select-sm" onchange="applyFilters()">
                    <option value="">Tümü</option>
                </select>
            </div>
            
            <!-- Bulk Updates -->
            <div class="col-md-3 d-flex align-items-end">
                <div class="input-group input-group-sm">
                    <span class="input-group-text">Toplu Spread (Kr)</span>
                    <input type="number" id="bulk-spread-tl-input" class="form-control" placeholder="Örn: 5">
                    <button class="btn btn-primary" onclick="applyBulkSpreadTL()">Uygula</button>
                </div>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <div class="input-group input-group-sm">
                    <span class="input-group-text">Toplu Spread Vol (%)</span>
                    <input type="number" id="bulk-spread-vol-input" class="form-control" placeholder="Örn: 5">
                    <button class="btn btn-warning" onclick="applyBulkSpreadVol()">Uygula</button>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm">
                <thead>
                    <tr>
                        <th onclick="sortTable('Opsiyon')" class="sort-icon" id="th-Opsiyon">Opsiyon</th>
                        <th onclick="sortTable('Dayanak')" class="sort-icon" id="th-Dayanak">Dayanak</th>
                        <th onclick="sortTable('Strike')" class="sort-icon" id="th-Strike">Strike</th>
                        <th onclick="sortTable('Tip')" class="sort-icon" id="th-Tip">Tip</th>
                        <th onclick="sortTable('Spot Fiyat')" class="sort-icon" id="th-Spot Fiyat">Spot Fiyat</th>
                        <th onclick="sortTable('Vade')" class="sort-icon" id="th-Vade">Vade</th>
                        <th onclick="sortTable('Volatilite')" class="sort-icon" id="th-Volatilite">Volatilite</th>
                        <th onclick="sortTable('FiyatRaw')" class="sort-icon" id="th-FiyatRaw">Teorik Fiyat</th>
                        <th>Spread (Kuruş)</th>
                        <th>Spread Vol (%)</th>
                        <th onclick="sortTable('VoldanKr')" class="sort-icon" id="th-VoldanKr">Voldan Kr</th>
                        <th onclick="sortTable('KrdenVol')" class="sort-icon" id="th-KrdenVol">Krden Vol</th>
                        <th>Ask IV</th>
                        <th>Ask Fiyat</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Veriler buraya gelecek -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- Black-Scholes Implementation (Client Side) ---
        function cumulativeDistribution(x) {
            var t = 1 / (1 + 0.2316419 * Math.abs(x));
            var d = 0.3989422804014337 * Math.exp(-x * x / 2);
            var prob = d * t * (0.319381530 + t * (-0.356563782 + t * (1.781477937 + t * (-1.821255978 + t * 1.330274429))));
            if (x > 0) prob = 1 - prob;
            return prob;
        }

        function blackScholes(S, K, T, sigma, type) {
            if (T <= 0) {
                return type === 'Call' ? Math.max(0, S - K) : Math.max(0, K - S);
            }
            var d1 = (Math.log(S / K) + (0.5 * sigma * sigma) * T) / (sigma * Math.sqrt(T));
            var d2 = d1 - sigma * Math.sqrt(T);
            
            if (type === 'Call') {
                return S * cumulativeDistribution(d1) - K * cumulativeDistribution(d2);
            } else {
                return K * cumulativeDistribution(-d2) - S * cumulativeDistribution(-d1);
            }
        }
        
        function getImpliedVolatility(expectedCost, s, k, t, type) {
             // expectedCost is in USD
             if (t <= 0) return 0;
             if (expectedCost <= 0) return 0; // Negative price implies no IV or broken spread
             
             let low = 0;
             let high = 5; // 500%
             let mid = 0;
             
             // Simple Bisection
             for (let i = 0; i < 20; i++) {
                 mid = (low + high) / 2;
                 let val = blackScholes(s, k, t, mid, type);
                 if (Math.abs(val - expectedCost) < 0.0001) break;
                 if (val < expectedCost) {
                     low = mid;
                 } else {
                     high = mid;
                 }
             }
             return mid;
        }

        // --- Application Logic ---
        let globalData = [];
        let sortCol = 'Opsiyon';
        let sortAsc = true;
        let isFilterInitialized = false;
        
        // Spread states
        let spreadTLState = {}; // { 'OpsiyonAdi': intValue (kuruş) }
        let spreadVolState = {}; // { 'OpsiyonAdi': floatValue (%) }

        function fetchData() {
            fetch('/api/data')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('status').innerText = 'Hata: ' + data.error;
                        document.getElementById('status').style.color = 'red';
                        return;
                    }

                    document.getElementById('status').innerText = 'Bağlantı Aktif | Son Güncelleme: ' + data.timestamp;
                    document.getElementById('status').style.color = '#198754';
                    
                    globalData = data.results;
                    
                    if (!isFilterInitialized) {
                        populateFilters();
                        isFilterInitialized = true;
                    }
                    
                    renderTable();
                })
                .catch(err => {
                    console.error('Fetch error:', err);
                    document.getElementById('status').innerText = 'Sunucuyla bağlantı kurulamadı.';
                    document.getElementById('status').style.color = 'red';
                });
        }

        function populateFilters() {
            // Vade Filtresi
            const vades = [...new Set(globalData.map(item => item.Vade))].sort();
            const selectVade = document.getElementById('filter-vade');
            const currentVade = selectVade.value;
            selectVade.innerHTML = '<option value="">Tümü</option>';
            vades.forEach(vade => {
                const option = document.createElement('option');
                option.value = vade;
                option.innerText = vade;
                selectVade.appendChild(option);
            });
            selectVade.value = currentVade;

            // Dayanak Filtresi
            const dayanaklar = [...new Set(globalData.map(item => item.Dayanak))].sort();
            const selectDayanak = document.getElementById('filter-dayanak');
            const currentDayanak = selectDayanak.value;
            selectDayanak.innerHTML = '<option value="">Tümü</option>';
            dayanaklar.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.innerText = item;
                selectDayanak.appendChild(option);
            });
            selectDayanak.value = currentDayanak;
        }

        function applyFilters() {
            renderTable();
        }

        function sortTable(column) {
            if (sortCol === column) {
                sortAsc = !sortAsc;
            } else {
                sortCol = column;
                sortAsc = true;
            }
            renderTable();
        }

        // --- Spread Updates ---

        // TL Spread
        window.updateSpreadTL = function(opsiyon, change) {
            if (!spreadTLState[opsiyon]) spreadTLState[opsiyon] = 0;
            spreadTLState[opsiyon] += change;
            renderTable();
        };

        window.setSpreadTL = function(opsiyon, value) {
            if (value === "") {
                spreadTLState[opsiyon] = 0;
            } else {
                let val = parseInt(value);
                if (isNaN(val)) val = 0;
                spreadTLState[opsiyon] = val;
            }
            renderTable(); 
        };

        window.applyBulkSpreadTL = function() {
            const bulkVal = parseInt(document.getElementById('bulk-spread-tl-input').value);
            if (isNaN(bulkVal)) return;
            applyBulkToState(spreadTLState, bulkVal);
            renderTable();
        };

        // Vol Spread
        window.updateSpreadVol = function(opsiyon, change) {
            if (!spreadVolState[opsiyon]) spreadVolState[opsiyon] = 0;
            spreadVolState[opsiyon] += change;
            renderTable();
        };

        window.setSpreadVol = function(opsiyon, value) {
            if (value === "") {
                spreadVolState[opsiyon] = 0;
            } else {
                let val = parseFloat(value);
                if (isNaN(val)) val = 0;
                spreadVolState[opsiyon] = val;
            }
            renderTable();
        };

        window.applyBulkSpreadVol = function() {
            const bulkVal = parseFloat(document.getElementById('bulk-spread-vol-input').value);
            if (isNaN(bulkVal)) return;
            applyBulkToState(spreadVolState, bulkVal);
            renderTable();
        };

        function applyBulkToState(stateObj, value) {
            const tipFilter = document.getElementById('filter-tip').value;
            const vadeFilter = document.getElementById('filter-vade').value;
            const dayanakFilter = document.getElementById('filter-dayanak').value;

            globalData.forEach(row => {
                if (tipFilter && row.Tip !== tipFilter) return;
                if (vadeFilter && row.Vade !== vadeFilter) return;
                if (dayanakFilter && row.Dayanak !== dayanakFilter) return;
                
                stateObj[row.Opsiyon] = value;
            });
        }

        function renderTable() {
            const tipFilter = document.getElementById('filter-tip').value;
            const vadeFilter = document.getElementById('filter-vade').value;
            const dayanakFilter = document.getElementById('filter-dayanak').value;

            // Focus koruma
            let activeElementId = null;
            let selectionStart = 0;
            let selectionEnd = 0;
            if (document.activeElement && document.activeElement.tagName === "INPUT") {
                activeElementId = document.activeElement.id;
                selectionStart = document.activeElement.selectionStart;
                selectionEnd = document.activeElement.selectionEnd;
            }

            // Filtreleme
            let filteredData = globalData.filter(row => {
                if (tipFilter && row.Tip !== tipFilter) return false;
                if (vadeFilter && row.Vade !== vadeFilter) return false;
                if (dayanakFilter && row.Dayanak !== dayanakFilter) return false;
                return true;
            });

            // Hesaplanmış değerleri önceden hesapla (sıralama için gerekli)
            let computedData = filteredData.map(row => {
                const opsiyonId = row['Opsiyon'];
                const spreadTL = spreadTLState[opsiyonId] !== undefined ? spreadTLState[opsiyonId] : 0;
                const spreadVol = spreadVolState[opsiyonId] !== undefined ? spreadVolState[opsiyonId] : 0;

                const rawVol = parseFloat(row['VolatiliteRaw']);
                const S = parseFloat(row['Spot Fiyat']);
                const K = parseFloat(row['Strike']);
                const T = parseFloat(row['T']);
                const type = row['Tip'];
                const usdtry = parseFloat(row['Kur']);
                const carpan = parseFloat(row['Carpan']);

                const newSigma = rawVol + (spreadVol / 100.0);
                const newPriceUSD = blackScholes(S, K, T, newSigma, type);
                let newPriceTRL = newPriceUSD * usdtry * carpan;
                newPriceTRL += (spreadTL / 100.0);

                const basePriceUSD = blackScholes(S, K, T, rawVol, type);
                const basePriceTRL = basePriceUSD * usdtry * carpan;

                let kurusIndicator = 0;
                if (spreadVol !== 0) {
                    const volSpreadPriceTRL = newPriceUSD * usdtry * carpan;
                    kurusIndicator = (volSpreadPriceTRL - basePriceTRL) * 100;
                }

                let volIndicator = 0;
                if (spreadTL !== 0 && usdtry > 0 && carpan > 0) {
                    const kurusOnlyPriceTRL = basePriceTRL + (spreadTL / 100.0);
                    const kurusOnlyPriceUSD = kurusOnlyPriceTRL / (usdtry * carpan);
                    if (kurusOnlyPriceUSD > 0) {
                        const kurusIV = getImpliedVolatility(kurusOnlyPriceUSD, S, K, T, type);
                        volIndicator = (kurusIV - rawVol) * 100;
                    }
                }

                let targetPriceUSD = 0;
                if (usdtry > 0 && carpan > 0) {
                    targetPriceUSD = newPriceTRL / (usdtry * carpan);
                }
                let askIV = 0;
                if (targetPriceUSD > 0) {
                    askIV = getImpliedVolatility(targetPriceUSD, S, K, T, type);
                }

                return { row, spreadTL, spreadVol, newPriceTRL, kurusIndicator, volIndicator, askIV };
            });

            // Sıralama
            computedData.sort((a, b) => {
                let valA, valB;

                if (sortCol === 'VoldanKr') {
                    valA = a.kurusIndicator;
                    valB = b.kurusIndicator;
                } else if (sortCol === 'KrdenVol') {
                    valA = a.volIndicator;
                    valB = b.volIndicator;
                } else {
                    valA = a.row[sortCol];
                    valB = b.row[sortCol];
                    if (['Spot Fiyat', 'Volatilite', 'FiyatRaw', 'Strike'].includes(sortCol)) {
                        valA = parseFloat(valA);
                        valB = parseFloat(valB);
                    }
                }

                if (valA < valB) return sortAsc ? -1 : 1;
                if (valA > valB) return sortAsc ? 1 : -1;
                return 0;
            });

            // Header Sınıflarını Güncelle
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            const activeTh = document.getElementById('th-' + sortCol);
            if (activeTh) {
                activeTh.classList.add(sortAsc ? 'sort-asc' : 'sort-desc');
            }

            // Tabloyu Doldur
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            computedData.forEach(({ row, spreadTL, spreadVol, newPriceTRL, kurusIndicator, volIndicator, askIV }) => {
                const opsiyonId = row['Opsiyon'];

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row['Opsiyon']}</td>
                    <td>${row['Dayanak']}</td>
                    <td>${row['Strike']}</td>
                    <td><span class="badge ${row['Tip'] === 'Call' ? 'text-bg-success' : 'text-bg-danger'}">${row['Tip']}</span></td>
                    <td>${row['Spot Fiyat']}</td>
                    <td>${row['Vade']}</td>
                    <td>${row['Volatilite']}</td>
                    <td class="text-secondary">${row['Fiyat']}</td>
                    
                    <!-- Spread TL -->
                    <td>
                        <div class="input-group input-group-sm spread-input-group">
                            <button class="btn btn-outline-secondary" onclick="updateSpreadTL('${opsiyonId}', -1)">-</button>
                            <input type="text" 
                                   id="spread-tl-${opsiyonId}"
                                   class="form-control" 
                                   value="${spreadTL}" 
                                   oninput="setSpreadTL('${opsiyonId}', this.value)"
                                   autocomplete="off">
                            <button class="btn btn-outline-secondary" onclick="updateSpreadTL('${opsiyonId}', 1)">+</button>
                        </div>
                    </td>

                    <!-- Spread Vol -->
                    <td>
                        <div class="input-group input-group-sm spread-input-group">
                            <button class="btn btn-outline-secondary" onclick="updateSpreadVol('${opsiyonId}', -1)">-</button>
                            <input type="text" 
                                   id="spread-vol-${opsiyonId}"
                                   class="form-control" 
                                   value="${spreadVol}" 
                                   oninput="setSpreadVol('${opsiyonId}', this.value)"
                                   autocomplete="off">
                            <button class="btn btn-outline-secondary" onclick="updateSpreadVol('${opsiyonId}', 1)">+</button>
                        </div>
                    </td>
                    
                    <!-- Kr Gösterge (Vol'den) -->
                    <td class="text-muted">${kurusIndicator !== 0 ? kurusIndicator.toFixed(2) : '-'}</td>

                    <!-- Vol Gösterge (Kr'den) -->
                    <td class="text-muted">${volIndicator !== 0 ? volIndicator.toFixed(2) + '%' : '-'}</td>

                    <!-- Ask IV -->
                    <td class="text-warning">${(askIV * 100).toFixed(2)}%</td>

                    <!-- Ask Fiyat -->
                    <td class="fw-bold text-info">${newPriceTRL.toFixed(2)} ₺</td>
                `;
                tbody.appendChild(tr);
            });

            // Focus restore
            if (activeElementId) {
                const el = document.getElementById(activeElementId);
                if (el) {
                    el.focus();
                    try {
                        el.setSelectionRange(selectionStart, selectionEnd);
                    } catch (e) {
                        console.warn("Cursor pozisyonu ayarlanamadı", e);
                    }
                }
            }
        }

        // İlk yükleme ve periyodik güncelleme
        fetchData();
        setInterval(fetchData, 1000); // 1 saniyede bir güncelle
    </script>
</body>
</html>